<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Mini Instagram</title>
  <style>
    body { font-family: Arial; background:#fafafa; margin:0 }
    #login, #app { max-width:400px; margin:auto }
    #chat { height:300px; overflow-y:auto; border:1px solid #ccc; padding:10px; background:white }
    .me { text-align:right; color:#0095f6 }
    .other { text-align:left; color:#262626 }
    input, button { width:100%; padding:10px; margin-top:5px }
    .post { border:1px solid #ddd; padding:10px; margin:10px 0; background:white }
    .story { display:inline-block; padding:10px; background:#ff0066; color:white; border-radius:50%; margin:5px }
  </style>
</head>
<body>

<div id="login">
  <h2>Giri≈ü</h2>
  <input id="username" placeholder="Kullanƒ±cƒ± adƒ±">
  <button onclick="login()">Giri≈ü Yap</button>
</div>

<div id="app" style="display:none">
  <h3>Story</h3>
  <input id="storyText" placeholder="Story yaz">
  <button onclick="addStory()">Payla≈ü</button>
  <div id="stories"></div>

  <h3>G√∂nderi</h3>
  <input id="postText" placeholder="G√∂nderi yaz">
  <button onclick="addPost()">Payla≈ü</button>
  <div id="posts"></div>

  <h3>DM</h3>
  <div id="chat"></div>
  <input id="message" placeholder="Mesaj yaz">
  <button onclick="sendMessage()">G√∂nder</button>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import {
    getFirestore, collection, addDoc,
    onSnapshot, query, orderBy, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

  // üî• KENDƒ∞ Fƒ∞REBASE Bƒ∞LGƒ∞LERƒ∞Nƒ∞ Gƒ∞R
  const firebaseConfig = {
    apiKey: "API_KEY",
    authDomain: "xxx.firebaseapp.com",
    projectId: "xxx",
    storageBucket: "xxx.appspot.com",
    messagingSenderId: "xxx",
    appId: "xxx"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  let user = "";

  window.login = () => {
    user = document.getElementById("username").value;
    if (!user) return alert("ƒ∞sim yaz");
    document.getElementById("login").style.display = "none";
    document.getElementById("app").style.display = "block";
  };

  // üí¨ DM (GER√áEK ZAMANLI)
  const chatRef = collection(db, "odalar", "genel", "mesajlar");
  const chatQuery = query(chatRef, orderBy("createdAt"));

  onSnapshot(chatQuery, snap => {
    const chat = document.getElementById("chat");
    chat.innerHTML = "";
    snap.forEach(doc => {
      const m = doc.data();
      const div = document.createElement("div");
      div.className = m.gonderen === user ? "me" : "other";
      div.innerText = m.gonderen + ": " + m.metin;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    });
  });

  window.sendMessage = async () => {
    const text = document.getElementById("message").value;
    if (!text) return;
    await addDoc(chatRef, {
      gonderen: user,
      metin: text,
      createdAt: serverTimestamp()
    });
    document.getElementById("message").value = "";
  };

  // üì∏ STORY
  const storyRef = collection(db, "stories");
  onSnapshot(storyRef, snap => {
    const s = document.getElementById("stories");
    s.innerHTML = "";
    snap.forEach(d => {
      const div = document.createElement("div");
      div.className = "story";
      div.innerText = d.data().kullanici;
      s.appendChild(div);
    });
  });

  window.addStory = async () => {
    const t = document.getElementById("storyText").value;
    if (!t) return;
    await addDoc(storyRef, {
      kullanici: user,
      text: t,
      createdAt: serverTimestamp()
    });
    document.getElementById("storyText").value = "";
  };

  // üñºÔ∏è G√ñNDERƒ∞
  const postRef = collection(db, "posts");
  const postQuery = query(postRef, orderBy("createdAt", "desc"));

  onSnapshot(postQuery, snap => {
    const p = document.getElementById("posts");
    p.innerHTML = "";
    snap.forEach(d => {
      const div = document.createElement("div");
      div.className = "post";
      div.innerHTML = `<b>${d.data().kullanici}</b><br>${d.data().text}`;
      p.appendChild(div);
    });
  });

  window.addPost = async () => {
    const t = document.getElementById("postText").value;
    if (!t) return;
    await addDoc(postRef, {
      kullanici: user,
      text: t,
      createdAt: serverTimestamp()
    });
    document.getElementById("postText").value = "";
  };
</script>
</body>
</html>