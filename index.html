<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Åžifreli Grup Sohbet</title>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getAuth,
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  getFirestore, collection, addDoc, serverTimestamp,
  query, orderBy, onSnapshot, doc, setDoc, updateDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import {
  getStorage, ref, uploadBytes, getDownloadURL
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyC4SczNrhYyr_sTPv7gHdNmdCW8fcQEahc",
  authDomain: "instafatih-28213.firebaseapp.com",
  projectId: "instafatih-28213",
  storageBucket: "instafatih-28213.appspot.com",
  messagingSenderId: "885847505120",
  appId: "1:885847505120:web:06e60cf83d229e8a437885"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

// ðŸ‘¤ AUTH KONTROL
onAuthStateChanged(auth, user => {
  if (user) {
    document.getElementById("auth").style.display = "none";
    document.getElementById("chatApp").style.display = "flex";

    setDoc(doc(db, "users", user.uid), {
      email: user.email,
      online: true
    }, { merge: true });
  }
});

// ðŸ” KAYIT
window.register = async () => {
  const email = emailInput.value;
  const pass = passwordInput.value;
  await createUserWithEmailAndPassword(auth, email, pass);
};

// ðŸ”‘ GÄ°RÄ°Åž
window.login = async () => {
  const email = emailInput.value;
  const pass = passwordInput.value;
  await signInWithEmailAndPassword(auth, email, pass);
};

// ðŸšª Ã‡IKIÅž
window.logout = async () => {
  await signOut(auth);
  location.reload();
};

// âœ‰ï¸ YAZI GÃ–NDER
window.sendText = async () => {
  const user = auth.currentUser;
  const text = msg.value.trim();
  if (!text) return;

  await addDoc(collection(db, "messages"), {
    uid: user.uid,
    email: user.email,
    text,
    image: null,
    createdAt: serverTimestamp(),
    readBy: []
  });
  msg.value = "";
};

// ðŸ–¼ï¸ RESÄ°M GÃ–NDER
window.sendImage = async () => {
  const user = auth.currentUser;
  const file = image.files[0];
  if (!file) return;

  const refImg = ref(storage, `images/${Date.now()}_${file.name}`);
  await uploadBytes(refImg, file);
  const url = await getDownloadURL(refImg);

  await addDoc(collection(db, "messages"), {
    uid: user.uid,
    email: user.email,
    text: "",
    image: url,
    createdAt: serverTimestamp(),
    readBy: []
  });

  image.value = "";
};

// ðŸ”„ MESAJLAR
onSnapshot(query(collection(db, "messages"), orderBy("createdAt")), snap => {
  const box = document.getElementById("messages");
  box.innerHTML = "";

  snap.forEach(async d => {
    const m = d.data();
    const me = auth.currentUser?.uid === m.uid;
    const div = document.createElement("div");
    div.className = me ? "me" : "other";

    let ticks = me ? (m.readBy.length > 1 ? "âœ“âœ“" : "âœ“") : "";

    let content = "";
    if (m.text) content += `<div class="bubble">${m.text}</div>`;
    if (m.image) content += `<img src="${m.image}">`;

    div.innerHTML = `<b>${m.email}</b> ${ticks}<br>${content}`;
    box.appendChild(div);

    if (auth.currentUser && !m.readBy.includes(auth.currentUser.uid)) {
      await updateDoc(doc(db, "messages", d.id), {
        readBy: [...m.readBy, auth.currentUser.uid]
      });
    }
  });

  box.scrollTop = box.scrollHeight;
});
</script>

<style>
body {
  font-family:Arial;
  background:#f0f2f5;
}
#auth {
  width:300px;
  margin:80px auto;
  background:white;
  padding:20px;
  border-radius:10px;
  box-shadow:0 0 10px #ccc;
}
#chatApp {
  display:none;
}
.me { text-align:right; margin:6px; }
.other { text-align:left; margin:6px; }
.bubble {
  display:inline-block;
  padding:6px 10px;
  border-radius:12px;
}
.me .bubble { background:#3797f0; color:white; }
.other .bubble { background:#eee; }
img { max-width:200px; border-radius:8px; margin-top:5px; }
</style>
</head>

<body>

<div id="auth">
  <h3>GiriÅŸ / KayÄ±t</h3>
  <input id="emailInput" placeholder="Email"><br><br>
  <input id="passwordInput" type="password" placeholder="Åžifre"><br><br>
  <button onclick="login()">GiriÅŸ</button>
  <button onclick="register()">KayÄ±t Ol</button>
</div>

<div id="chatApp">
  <button onclick="logout()">Ã‡Ä±kÄ±ÅŸ</button>
  <div id="messages"></div>
  <input id="msg" placeholder="Mesaj">
  <button onclick="sendText()">GÃ¶nder</button><br><br>
  <input type="file" id="image">
  <button onclick="sendImage()">Resim</button>
</div>

</body>
</html>