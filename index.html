<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Grup Sohbet + Resim</title>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore,
  collection,
  addDoc,
  serverTimestamp,
  query,
  orderBy,
  onSnapshot,
  doc,
  updateDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import {
  getStorage,
  ref,
  uploadBytes,
  getDownloadURL
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyC4SczNrhYyr_sTPv7gHdNmdCW8fcQEahc",
  authDomain: "instafatih-28213.firebaseapp.com",
  projectId: "instafatih-28213",
  storageBucket: "instafatih-28213.appspot.com",
  messagingSenderId: "885847505120",
  appId: "1:885847505120:web:06e60cf83d229e8a437885"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);

// ðŸ‘¤ KullanÄ±cÄ±
const user = prompt("KullanÄ±cÄ± adÄ±n:");
if (!user) location.reload();

// âœ‰ï¸ YazÄ± gÃ¶nder
window.sendText = async () => {
  const input = document.getElementById("msg");
  if (!input.value.trim()) return;

  await addDoc(collection(db, "messages"), {
    sender: user,
    text: input.value,
    image: null,
    createdAt: serverTimestamp(),
    readBy: []
  });

  input.value = "";
};

// ðŸ–¼ï¸ Resim gÃ¶nder
window.sendImage = async () => {
  const fileInput = document.getElementById("image");
  const file = fileInput.files[0];
  if (!file) return;

  const imageRef = ref(storage, `images/${Date.now()}_${file.name}`);
  await uploadBytes(imageRef, file);
  const url = await getDownloadURL(imageRef);

  await addDoc(collection(db, "messages"), {
    sender: user,
    text: "",
    image: url,
    createdAt: serverTimestamp(),
    readBy: []
  });

  fileInput.value = "";
};

// ðŸ”„ MesajlarÄ± dinle
const q = query(collection(db, "messages"), orderBy("createdAt"));
onSnapshot(q, (snap) => {
  const box = document.getElementById("messages");
  box.innerHTML = "";

  snap.forEach(async (d) => {
    const m = d.data();
    const div = document.createElement("div");
    div.className = m.sender === user ? "me" : "other";

    let content = "";
    if (m.text) content += `<div>${m.text}</div>`;
    if (m.image) content += `<img src="${m.image}">`;

    div.innerHTML = `<b>${m.sender}</b><br>${content}`;
    box.appendChild(div);

    if (!m.readBy.includes(user)) {
      await updateDoc(doc(db, "messages", d.id), {
        readBy: [...m.readBy, user]
      });
    }
  });

  box.scrollTop = box.scrollHeight;
});
</script>

<style>
body {
  background:#f0f2f5;
  font-family:Arial;
}
#chat {
  width:420px;
  margin:30px auto;
  background:white;
  border-radius:10px;
  box-shadow:0 0 10px #ccc;
}
#messages {
  height:350px;
  overflow-y:auto;
  padding:10px;
}
.me { text-align:right; margin:6px; }
.other { text-align:left; margin:6px; }
.me div, .other div {
  display:inline-block;
  padding:6px 10px;
  border-radius:12px;
}
.me div { background:#3797f0; color:white; }
.other div { background:#eee; }
img {
  max-width:200px;
  margin-top:5px;
  border-radius:8px;
}
#bottom {
  border-top:1px solid #ddd;
  padding:8px;
}
input[type=text] {
  width:100%;
  padding:8px;
  margin-bottom:5px;
}
</style>
</head>

<body>

<div id="chat">
  <div id="messages"></div>
  <div id="bottom">
    <input id="msg" type="text" placeholder="Mesaj yaz">
    <button onclick="sendText()">GÃ¶nder</button><br><br>
    <input id="image" type="file" accept="image/*">
    <button onclick="sendImage()">Resim GÃ¶nder</button>
  </div>
</div>

</body>
</html>