<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>DM Chat</title>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, collection, addDoc, serverTimestamp,
  query, orderBy, onSnapshot, doc, updateDoc, setDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyC4SczNrhYyr_sTPv7gHdNmdCW8fcQEahc",
  authDomain: "instafatih-28213.firebaseapp.com",
  projectId: "instafatih-28213",
  storageBucket: "instafatih-28213.appspot.com",
  messagingSenderId: "885847505120",
  appId: "1:885847505120:web:06e60cf83d229e8a437885"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ðŸ‘¤ KullanÄ±cÄ±lar
const me = prompt("KullanÄ±cÄ± adÄ±n:");
const other = prompt("Mesaj gÃ¶ndereceÄŸin kiÅŸi:");

// ðŸ” ODA ID (iki isim alfabetik)
const room =
  [me, other].sort().join("_");

// ðŸŸ¢ Online durumu
const myRef = doc(db, "users", me);
await setDoc(myRef, { online: true }, { merge: true });
window.onbeforeunload = () =>
  setDoc(myRef, { online: false }, { merge: true });

// âœ‰ï¸ Mesaj gÃ¶nder
window.send = async () => {
  const input = document.getElementById("msg");
  if (!input.value.trim()) return;

  await addDoc(collection(db, "messages"), {
    room,
    from: me,
    to: other,
    text: input.value,
    time: serverTimestamp(),
    read: false
  });

  input.value = "";
};

// ðŸ”„ MesajlarÄ± dinle (SADECE BU ODA)
const q = query(
  collection(db, "messages"),
  orderBy("time")
);

onSnapshot(q, (snap) => {
  const box = document.getElementById("messages");
  box.innerHTML = "";

  snap.forEach(async (d) => {
    const m = d.data();
    if (m.room !== room) return;

    const div = document.createElement("div");
    div.className = m.from === me ? "me" : "other";

    let seen = "";
    if (m.from === me) {
      seen = m.read ? "âœ“âœ“" : "âœ“";
    }

    div.innerHTML = `<span>${m.text}</span><small>${seen}</small>`;
    box.appendChild(div);

    // ðŸ‘€ Okundu
    if (m.to === me && !m.read) {
      await updateDoc(doc(db, "messages", d.id), {
        read: true
      });
    }
  });

  box.scrollTop = box.scrollHeight;
});
</script>

<style>
body {
  font-family: Arial;
  background:#f0f2f5;
}
#chat {
  width:360px;
  margin:40px auto;
  background:white;
  border-radius:12px;
}
#messages {
  height:350px;
  overflow-y:auto;
  padding:10px;
}
.me { text-align:right; margin:6px; }
.other { text-align:left; margin:6px; }
.me span {
  background:#3797f0;
  color:white;
  padding:6px 10px;
  border-radius:15px;
  display:inline-block;
}
.other span {
  background:#eee;
  padding:6px 10px;
  border-radius:15px;
  display:inline-block;
}
small {
  font-size:10px;
  margin-left:4px;
}
#bottom {
  display:flex;
  border-top:1px solid #ddd;
}
input {
  flex:1;
  border:none;
  padding:10px;
}
button {
  border:none;
  background:#3797f0;
  color:white;
  padding:10px;
}
</style>
</head>

<body>
<div id="chat">
  <div id="messages"></div>
  <div id="bottom">
    <input id="msg" placeholder="Mesaj yaz...">
    <button onclick="send()">GÃ¶nder</button>
  </div>
</div>
</body>
</html>