<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Full Paket Grup Sohbet</title>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, collection, addDoc, serverTimestamp,
  query, orderBy, onSnapshot, doc, updateDoc, setDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import {
  getStorage, ref, uploadBytes, getDownloadURL
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyC4SczNrhYyr_sTPv7gHdNmdCW8fcQEahc",
  authDomain: "instafatih-28213.firebaseapp.com",
  projectId: "instafatih-28213",
  storageBucket: "instafatih-28213.appspot.com",
  messagingSenderId: "885847505120",
  appId: "1:885847505120:web:06e60cf83d229e8a437885"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);

// ðŸ‘¤ KullanÄ±cÄ±
const user = prompt("KullanÄ±cÄ± adÄ±n:");
if (!user) location.reload();

// ðŸŸ¢ Online
await setDoc(doc(db, "users", user), { online: true }, { merge: true });
window.onbeforeunload = () =>
  setDoc(doc(db, "users", user), { online: false }, { merge: true });

// âœ‰ï¸ YazÄ± gÃ¶nder
window.sendText = async () => {
  const input = document.getElementById("msg");
  if (!input.value.trim()) return;

  await addDoc(collection(db, "messages"), {
    sender: user,
    text: input.value,
    image: null,
    createdAt: serverTimestamp(),
    readBy: []
  });
  input.value = "";
};

// ðŸ–¼ï¸ Resim gÃ¶nder
window.sendImage = async () => {
  const file = document.getElementById("image").files[0];
  if (!file) return;

  const imgRef = ref(storage, `images/${Date.now()}_${file.name}`);
  await uploadBytes(imgRef, file);
  const url = await getDownloadURL(imgRef);

  await addDoc(collection(db, "messages"), {
    sender: user,
    text: "",
    image: url,
    createdAt: serverTimestamp(),
    readBy: []
  });

  document.getElementById("image").value = "";
};

// ðŸ”„ Mesajlar
onSnapshot(query(collection(db, "messages"), orderBy("createdAt")), (snap) => {
  const box = document.getElementById("messages");
  box.innerHTML = "";

  snap.forEach(async d => {
    const m = d.data();
    const div = document.createElement("div");
    div.className = m.sender === user ? "me" : "other";

    let ticks = "";
    if (m.sender === user) {
      ticks = m.readBy.length > 1 ? "âœ“âœ“" : "âœ“";
    }

    let content = "";
    if (m.text) content += `<div class="bubble">${m.text}</div>`;
    if (m.image) content += `<img src="${m.image}">`;

    div.innerHTML = `<b>${m.sender}</b>${ticks}<br>${content}`;
    box.appendChild(div);

    if (!m.readBy.includes(user)) {
      await updateDoc(doc(db, "messages", d.id), {
        readBy: [...m.readBy, user]
      });
    }
  });

  box.scrollTop = box.scrollHeight;
});

// ðŸ‘¥ Online kullanÄ±cÄ±lar
onSnapshot(collection(db, "users"), (snap) => {
  const list = document.getElementById("online");
  list.innerHTML = "";
  snap.forEach(d => {
    if (d.data().online) {
      const li = document.createElement("li");
      li.innerText = d.id;
      list.appendChild(li);
    }
  });
});
</script>

<style>
body {
  background:#f0f2f5;
  font-family:Arial;
  display:flex;
}
#users {
  width:150px;
  background:#fff;
  padding:10px;
  border-right:1px solid #ddd;
}
#chat {
  width:420px;
  margin:20px auto;
  background:white;
  border-radius:10px;
  box-shadow:0 0 10px #ccc;
}
#messages {
  height:350px;
  overflow-y:auto;
  padding:10px;
}
.me { text-align:right; margin:8px; }
.other { text-align:left; margin:8px; }
.bubble {
  display:inline-block;
  padding:6px 10px;
  border-radius:12px;
}
.me .bubble { background:#3797f0; color:white; }
.other .bubble { background:#eee; }
img {
  max-width:200px;
  margin-top:5px;
  border-radius:8px;
}
#bottom {
  border-top:1px solid #ddd;
  padding:8px;
}
</style>
</head>

<body>

<div id="users">
  <b>Online</b>
  <ul id="online"></ul>
</div>

<div id="chat">
  <div id="messages"></div>
  <div id="bottom">
    <input id="msg" placeholder="Mesaj yaz"><br><br>
    <button onclick="sendText()">GÃ¶nder</button><br><br>
    <input type="file" id="image" accept="image/*">
    <button onclick="sendImage()">Resim</button>
  </div>
</div>

</body>
</html>