<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>DM Listeli Chat</title>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, collection, addDoc, serverTimestamp,
  query, orderBy, onSnapshot, doc, updateDoc, setDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyC4SczNrhYyr_sTPv7gHdNmdCW8fcQEahc",
  authDomain: "instafatih-28213.firebaseapp.com",
  projectId: "instafatih-28213",
  storageBucket: "instafatih-28213.appspot.com",
  messagingSenderId: "885847505120",
  appId: "1:885847505120:web:06e60cf83d229e8a437885"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ðŸ‘¤ KullanÄ±cÄ±
const me = prompt("KullanÄ±cÄ± adÄ±n:");
const myRef = doc(db, "users", me);
await setDoc(myRef, { online: true }, { merge: true });
window.onbeforeunload = () =>
  setDoc(myRef, { online: false }, { merge: true });

let currentChat = null;

// ðŸ”„ DM LISTESI
onSnapshot(collection(db, "messages"), (snap) => {
  const list = document.getElementById("dmList");
  list.innerHTML = "";
  const rooms = new Set();

  snap.forEach(d => {
    const m = d.data();
    if (m.from === me || m.to === me) {
      const other = m.from === me ? m.to : m.from;
      rooms.add(other);
    }
  });

  rooms.forEach(user => {
    const div = document.createElement("div");
    div.className = "dm";
    div.innerText = user;
    div.onclick = () => openChat(user);
    list.appendChild(div);
  });
});

// ðŸ“© CHAT AÃ‡
window.openChat = (user) => {
  currentChat = user;
  document.getElementById("chatTitle").innerText = user;
};

// âœ‰ï¸ MESAJ GÃ–NDER
window.send = async () => {
  if (!currentChat) return alert("Ã–nce DM seÃ§");

  const input = document.getElementById("msg");
  if (!input.value.trim()) return;

  const room = [me, currentChat].sort().join("_");

  await addDoc(collection(db, "messages"), {
    room,
    from: me,
    to: currentChat,
    text: input.value,
    time: serverTimestamp(),
    read: false
  });

  input.value = "";
};

// ðŸ”„ MESAJLARI DINLE
onSnapshot(query(collection(db, "messages"), orderBy("time")), (snap) => {
  const box = document.getElementById("messages");
  box.innerHTML = "";

  snap.forEach(async d => {
    const m = d.data();
    if (!currentChat) return;
    if (
      (m.from === me && m.to === currentChat) ||
      (m.from === currentChat && m.to === me)
    ) {
      const div = document.createElement("div");
      div.className = m.from === me ? "me" : "other";

      let seen = "";
      if (m.from === me) seen = m.read ? "âœ“âœ“" : "âœ“";

      div.innerHTML = `<span>${m.text}</span><small>${seen}</small>`;
      box.appendChild(div);

      if (m.to === me && !m.read) {
        await updateDoc(doc(db, "messages", d.id), { read: true });
      }
    }
  });

  box.scrollTop = box.scrollHeight;
});
</script>

<style>
body {
  margin:0;
  font-family:Arial;
  display:flex;
  height:100vh;
}
#sidebar {
  width:30%;
  border-right:1px solid #ddd;
  background:#fafafa;
}
#dmList .dm {
  padding:15px;
  cursor:pointer;
  border-bottom:1px solid #eee;
}
#dmList .dm:hover {
  background:#eee;
}
#chat {
  flex:1;
  display:flex;
  flex-direction:column;
}
#header {
  padding:15px;
  border-bottom:1px solid #ddd;
}
#messages {
  flex:1;
  padding:10px;
  overflow-y:auto;
}
.me { text-align:right; margin:6px; }
.other { text-align:left; margin:6px; }
.me span {
  background:#3797f0;
  color:white;
  padding:6px 10px;
  border-radius:15px;
}
.other span {
  background:#eee;
  padding:6px 10px;
  border-radius:15px;
}
small {
  font-size:10px;
  margin-left:4px;
}
#bottom {
  display:flex;
  border-top:1px solid #ddd;
}
input {
  flex:1;
  padding:10px;
  border:none;
}
button {
  padding:10px;
  background:#3797f0;
  color:white;
  border:none;
}
</style>
</head>

<body>

<div id="sidebar">
  <h3 style="padding:10px">DMâ€™ler</h3>
  <div id="dmList"></div>
</div>

<div id="chat">
  <div id="header">
    <b id="chatTitle">DM seÃ§</b>
  </div>
  <div id="messages"></div>
  <div id="bottom">
    <input id="msg" placeholder="Mesaj yaz...">
    <button onclick="send()">GÃ¶nder</button>
  </div>
</div>

</body>
</html>